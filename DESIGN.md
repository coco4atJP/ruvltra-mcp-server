# RuvLTRA MCP Server 設計ドキュメント

## 1. システム概要
本システムは、Claude Code、Gemini CLI、Codex 等の高度なAIエージェント（指示塔）から呼び出されることを想定した **MCP (Model Context Protocol) サーバー** です。
メインのAIエージェントが持つ高い推論・設計能力と、軽量かつ自己学習機能を持つ「**ruv/ruvltra-claude-code**」モデルの処理速度を組み合わせることで、**高速かつ低コストなバイブコーディング (Vibe Coding)** の実現を目的とします。

## 2. アーキテクチャ構成
システムは大きく以下の3つの層で構成されます。

### 2.1. MCP インターフェース層
*   クライアント（Claude Code等）からの接続を受け付けるエントリーポイント。
*   JSON-RPC 等のMCPプロトコルに準拠し、サーバーが提供するツールの定義の公開、およびツール実行要求（リクエスト）の受け付け・レスポンスの返却を行います。

### 2.2. タスク管理・並列処理層 (Concurrency Manager)
*   バイブコーディングの最大のメリットである「高速化」を実現するため、メインエージェントから非同期に送られてくる複数のタスク（ファイルの並列生成、複数箇所のリファクタリングなど）を管理します。
*   必要に応じてタスクキューイングや、RuvLLMセッションへのルーティングを行います。

### 2.3. 推論エンジン・自己学習層 (RuvLLM Engine)
*   **RuvLLM (`@ruvector/ruvllm`)** をバックエンドの推論エンジンとして利用します。
*   **ruvltra-claude-code** モデルをロードし、コード生成・補完・リファクタリングなどの実処理を行います。
*   **SONA (Self-Optimizing Neural Architecture)** 機能を利用することで、処理を実行するたびにユーザーのコーディングスタイルやプロジェクトの規約をリアルタイムに学習（自己改善）し、使えば使うほど精度とプロジェクトへの適合性が向上します。

## 3. 提供するMCPツール (API設計案)
メインエージェントに対して、以下のようなツールを公開することを想定しています。

### `generate_vibe_code`
*   **目的:** 指定されたコンテキスト（周辺コードなど）と指示に基づいて、コードスニペットや関数を高速に生成・修正する。
*   **パラメータ:**
    *   `instruction`: 修正・生成の指示
    *   `context`: 対象ファイルの内容や周辺の関連コード
    *   `file_path` (Optional): 学習用にプロジェクト構造を把握するためのファイルパス
*   **戻り値:** 生成されたコード

### `refactor_vibe_code`
*   **目的:** RuvLLMがこれまでに学習した「プロジェクト固有のスタイル・規約」に基づいて、既存のコードをリファクタリング（最適化）する。
*   **パラメータ:**
    *   `code`: リファクタリング対象のコード
*   **戻り値:** リファクタリングされたコードと、修正の簡単な理由

## 4. 全体の処理フロー（動作イメージ）
1.  **設計・分割:** メインエージェント (Claude Code等) がユーザーの抽象的な要望を解釈し、システム設計と「どのファイルをどう変更するか」という具体的なタスクに分割する。
2.  **非同期呼び出し:** メインエージェントは、分割したタスクごとにMCP経由で `generate_vibe_code` などを並列（非同期）で呼び出す。
3.  **高速処理・自己学習:** MCPサーバーはタスクを受け取り、RuvLLM (ruvltra) で処理。この実行過程で、RuvLLMは提示されたコードや指示からプロジェクトのスタイルを学習し、適応させる。
4.  **結果の集約:** 生成されたコードがメインエージェントに高速で返却され、メインエージェントが最終的なファイルの更新（`write_file` など）や整合性の確認を行う。

## 5. 今後のステップ・課題
*   **RuvLLMの組み込み:** Node.js (TypeScript) 上で `@ruvector/ruvllm` のパッケージを利用し、正常にモデルのロードと推論（SONAの有効化）ができるかのPoC実装。
*   **MCP SDKの選定:** `@modelcontextprotocol/sdk` 等を利用したサーバー実装の構築。
*   **並列処理の最適化:** RuvLLMが複数の並列リクエストを効率的に捌けるよう、セッション管理やメモリ割り当ての調整。
